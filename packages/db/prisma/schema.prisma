generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------------------
// ENUM STRATEGY
// ---------------------------------------------------------------------------
// Prisma 5 does not support the `enum` keyword with the SQLite provider —
// the schema validator rejects it entirely. Enum values are stored as String
// columns here and enforced at the application layer (Zod + TypeScript unions
// in @crm/types). When migrating to PostgreSQL, these columns become native
// PostgreSQL enum types via a single Prisma migration — no application code
// changes required.
//
// Valid values are documented alongside each field below.
// ---------------------------------------------------------------------------

model Lead {
  id              String    @id @default(uuid())
  name            String
  email           String
  phone           String
  // status: "NEW" | "IN_SEQUENCE" | "RESPONDED" | "BOOKED" | "CLOSED"
  status          String    @default("NEW")
  sequenceDay     Int       @default(0)
  lastContactedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  messageLogs MessageLog[]

  // email is unique — used as the idempotency key when creating leads from
  // inbound emails. Upsert on email means the same lead is never duplicated
  // even if the same forwarded email is delivered more than once.
  @@unique([email])
  @@index([phone])
  @@index([status])
}

model InboundEmail {
  id        String   @id @default(uuid())
  subject   String
  rawText   String
  // processed: tracks whether this email has been parsed and acted on
  processed Boolean  @default(false)
  // error: populated if processing failed, null on success
  error     String?
  createdAt DateTime @default(now())
}

model MessageLog {
  id      String   @id @default(uuid())
  leadId  String
  // direction: "OUTBOUND" | "INBOUND"
  direction String
  body    String
  sentAt  DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([direction])
}
